import React, { useEffect, useState } from 'react';
import { useFormik } from 'formik';
import { useParams, useNavigate } from 'react-router-dom';
import axios from 'axios';
import Swal from 'sweetalert2';
import * as Yup from 'yup';

const FormEdition = () => {
    const { id } = useParams();
    const navigate = useNavigate();
    const [cve, setCve] = useState(null);

    useEffect(() => {
        axios.get(`http://localhost:8000/api/cves/${id}`)
            .then((res) => {
                setCve(res.data);
                formik.setValues({
                    cveId: res.data.cveId || '',
                    severity: res.data.severity || '',
                    description: res.data.description || '',
                    publishedDate: res.data.publishedDate || '',
                    lastModifiedDate: res.data.lastModifiedDate || '',
                });
            })
            .catch((err) => {
                console.log(err);
            });
    }, [id]);

    const formik = useFormik({
        initialValues: {
            cveId: '',
            severity: '',
            description: '',
            publishedDate: '',
            lastModifiedDate: '',
        },

        validationSchema: Yup.object({
            cveId: Yup.string()
                .min(9, 'CVE Id must be at least 9 characters')
                .required('CVE is required!!!'),
            severity: Yup.string()
                .min(3, 'Severity must have at least 3 characters')
                .required('Severity is required, Low, Medium or High'),
        }),
        onSubmit: (values, { setSubmitting, setErrors }) => {
            axios.put(`http://localhost:8000/api/cves/update/${id}`, values)
                .then((res) => {
                    console.log(res);
                    navigate('/cve/getall');
                })
                .catch((err) => {
                    console.log(err);
                    if (err.response && err.response.data.field === 'cveId') {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: err.response.data.message,
                        });
                    } else if (err.response && err.response.data.errors) {
                        setErrors(err.response.data.errors);
                    }
                })
                .finally(() => {
                    setSubmitting(false);
                });
        },
    });

    return (
        <div className='col-6 mx-auto'>
            <div className='col mx-auto d-flex flex-row'>
                <h1>Edit: {cve ? cve.cveId : 'Loading...'}</h1>
            </div>
            <form onSubmit={formik.handleSubmit}>
                <div className='forms'>
                    <div className='formLeft'>
                        <div className='form-group m-2'>
                            <label className='form-label'>CVE Id:</label>
                            <input
                                className={`form-control mt-2 ${formik.touched.cveId && formik.errors.cveId ? 'is-invalid' : ''}`}
                                type="text"
                                name="cveId"
                                onChange={formik.handleChange}
                                onBlur={formik.handleBlur}
                                value={formik.values.cveId}
                            />
                            {formik.touched.cveId && formik.errors.cveId && (
                                <span className='text-danger m-3'>{formik.errors.cveId}</span>
                            )}
                        </div>
                        <div className='form-group m-2'>
                            <label className='form-label'>Severity:</label>
                            <input
                                className={`form-control mt-2 ${formik.touched.severity && formik.errors.severity ? 'is-invalid' : ''}`}
                                type="text"
                                name="severity"
                                onChange={formik.handleChange}
                                onBlur={formik.handleBlur}
                                value={formik.values.severity}
                            />
                            {formik.touched.severity && formik.errors.severity && (
                                <span className='text-danger m-3'>{formik.errors.severity}</span>
                            )}
                        </div>
                        <div className='form-group m-2'>
                            <label className='form-label'>Description</label>
                            <input
                                className={`form-control mt-2 ${formik.touched.description && formik.errors.description ? 'is-invalid' : ''}`}
                                type="text"
                                name="description"
                                onChange={formik.handleChange}
                                onBlur={formik.handleBlur}
                                value={formik.values.description}
                            />
                            {formik.touched.description && formik.errors.description && (
                                <span className='text-danger m-3'>{formik.errors.description}</span>
                            )}
                        </div>
                    </div>
                    <div className='formRight'>
                        <div className='form-group m-2'>
                            <label className='form-label'>Published Date</label>
                            <input
                                className={`form-control mt-2 ${formik.touched.publishedDate && formik.errors.publishedDate ? 'is-invalid' : ''}`}
                                type="text"
                                name="publishedDate"
                                onChange={formik.handleChange}
                                onBlur={formik.handleBlur}
                                value={formik.values.publishedDate}
                            />
                            {formik.touched.publishedDate && formik.errors.publishedDate && (
                                <span className='text-danger m-3'>{formik.errors.publishedDate}</span>
                            )}
                        </div>
                        <div className='form-group m-2'>
                            <label className='form-label'>Last Modified Date</label>
                            <input
                                className={`form-control mt-2 ${formik.touched.lastModifiedDate && formik.errors.lastModifiedDate ? 'is-invalid' : ''}`}
                                type="text"
                                name="lastModifiedDate"
                                onChange={formik.handleChange}
                                onBlur={formik.handleBlur}
                                value={formik.values.lastModifiedDate}
                            />
                            {formik.touched.lastModifiedDate && formik.errors.lastModifiedDate && (
                                <span className='text-danger m-3'>{formik.errors.lastModifiedDate}</span>
                            )}
                        </div>
                    </div>
                </div>
                <button className='btn btn-primary' type="submit" disabled={formik.isSubmitting}>
                    Update CVE!
                </button>
            </form>
            <a className='btn btn-success mt-3 mb-3' href='/cve/getall'><strong>Back to Dashboard</strong></a>
        </div>
    );
};

export default FormEdition;

 
